<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-card {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .status-card.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .status-card.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .status-card.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .status-card.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4facfe;
            color: white;
        }
        button:hover { background: #00f2fe; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .action-buttons {
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥</h1>
        <p>æ­¤å·¥å…·ç”¨æ–¼æª¢æŸ¥ Supabase è³‡æ–™åº«çš„ç‹€æ…‹å’Œçµæ§‹ã€‚</p>

        <div class="action-buttons">
            <button onclick="checkDatabaseStatus()">æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹</button>
            <button onclick="createSampleData()">å‰µå»ºç¯„ä¾‹è³‡æ–™</button>
            <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>

        <div id="results"></div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        const resultsDiv = document.getElementById('results');

        function addResult(title, content, type = 'info') {
            const card = document.createElement('div');
            card.className = `status-card ${type}`;
            card.innerHTML = `
                <h3>${title}</h3>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(card);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function checkDatabaseStatus() {
            clearResults();
            addResult('ğŸ” é–‹å§‹æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹...', 'æ­£åœ¨é€£æ¥åˆ° Supabase...', 'info');

            try {
                // 1. æª¢æŸ¥ Supabase é€£æ¥
                addResult('1. Supabase é€£æ¥æ¸¬è©¦', 'æ­£åœ¨æ¸¬è©¦é€£æ¥...', 'info');
                
                if (!window.supabaseClient) {
                    addResult('âŒ Supabase å®¢æˆ¶ç«¯æœªåˆå§‹åŒ–', 'è«‹æª¢æŸ¥ supabase-config.js æª”æ¡ˆ', 'error');
                    return;
                }

                // 2. æª¢æŸ¥ events è¡¨
                addResult('2. Events è¡¨æª¢æŸ¥', 'æ­£åœ¨æª¢æŸ¥ events è¡¨...', 'info');
                await checkEventsTable();

                // 3. æª¢æŸ¥ registrations è¡¨
                addResult('3. Registrations è¡¨æª¢æŸ¥', 'æ­£åœ¨æª¢æŸ¥ registrations è¡¨...', 'info');
                await checkRegistrationsTable();

                // 4. æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
                addResult('4. è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥', 'æ­£åœ¨æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§...', 'info');
                await checkDataIntegrity();

                addResult('âœ… æª¢æŸ¥å®Œæˆ', 'æ‰€æœ‰æª¢æŸ¥å·²å®Œæˆï¼Œè«‹æŸ¥çœ‹ä¸Šè¿°çµæœ', 'success');

            } catch (error) {
                addResult('âŒ æª¢æŸ¥å¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                console.error('è³‡æ–™åº«æª¢æŸ¥å¤±æ•—:', error);
            }
        }

        async function checkEventsTable() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('events')
                    .select('*')
                    .limit(5);

                if (error) {
                    if (error.message.includes('relation "events" does not exist')) {
                        addResult('âŒ Events è¡¨ä¸å­˜åœ¨', `
                            <p>Events è¡¨å°šæœªå‰µå»ºï¼Œéœ€è¦åŸ·è¡Œè³‡æ–™åº«åˆå§‹åŒ–ã€‚</p>
                            <p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
                            <ul>
                                <li>åœ¨ Supabase æ§åˆ¶å°åŸ·è¡Œ SQL è…³æœ¬</li>
                                <li>æˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œå‰µå»ºç¯„ä¾‹è³‡æ–™ã€æŒ‰éˆ•</li>
                            </ul>
                        `, 'error');
                    } else {
                        addResult('âš ï¸ Events è¡¨æŸ¥è©¢å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'warning');
                    }
                    return;
                }

                if (data && data.length > 0) {
                    const sampleEvent = data[0];
                    const columns = Object.keys(sampleEvent);
                    const activeEvents = data.filter(e => e.active).length;
                    
                    addResult('âœ… Events è¡¨æ­£å¸¸', `
                        <p><strong>è¡¨ç‹€æ…‹ï¼š</strong>æ­£å¸¸</p>
                        <p><strong>ç¸½è¨˜éŒ„æ•¸ï¼š</strong>${data.length} ç­†</p>
                        <p><strong>å•Ÿç”¨æ´»å‹•ï¼š</strong>${activeEvents} å€‹</p>
                        <p><strong>æ¬„ä½ï¼š</strong>${columns.join(', ')}</p>
                        <p><strong>ç¯„ä¾‹è³‡æ–™ï¼š</strong></p>
                        <pre>${JSON.stringify(sampleEvent, null, 2)}</pre>
                    `, 'success');
                } else {
                    addResult('âš ï¸ Events è¡¨ç‚ºç©º', `
                        <p>Events è¡¨å­˜åœ¨ä½†æ²’æœ‰è³‡æ–™ã€‚</p>
                        <p>å»ºè­°ä½¿ç”¨ã€Œå‰µå»ºç¯„ä¾‹è³‡æ–™ã€æŒ‰éˆ•æ·»åŠ æ¸¬è©¦æ´»å‹•ã€‚</p>
                    `, 'warning');
                }

            } catch (error) {
                addResult('âŒ Events è¡¨æª¢æŸ¥å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkRegistrationsTable() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('registrations')
                    .select('*')
                    .limit(5);

                if (error) {
                    if (error.message.includes('relation "registrations" does not exist')) {
                        addResult('âŒ Registrations è¡¨ä¸å­˜åœ¨', `
                            <p>Registrations è¡¨å°šæœªå‰µå»ºï¼Œéœ€è¦åŸ·è¡Œè³‡æ–™åº«åˆå§‹åŒ–ã€‚</p>
                            <p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
                            <ul>
                                <li>åœ¨ Supabase æ§åˆ¶å°åŸ·è¡Œ SQL è…³æœ¬</li>
                                <li>æˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œå‰µå»ºç¯„ä¾‹è³‡æ–™ã€æŒ‰éˆ•</li>
                            </ul>
                        `, 'error');
                    } else {
                        addResult('âš ï¸ Registrations è¡¨æŸ¥è©¢å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'warning');
                    }
                    return;
                }

                if (data && data.length > 0) {
                    const sampleReg = data[0];
                    const columns = Object.keys(sampleReg);
                    
                    addResult('âœ… Registrations è¡¨æ­£å¸¸', `
                        <p><strong>è¡¨ç‹€æ…‹ï¼š</strong>æ­£å¸¸</p>
                        <p><strong>ç¸½è¨˜éŒ„æ•¸ï¼š</strong>${data.length} ç­†</p>
                        <p><strong>æ¬„ä½ï¼š</strong>${columns.join(', ')}</p>
                        <p><strong>ç¯„ä¾‹è³‡æ–™ï¼š</strong></p>
                        <pre>${JSON.stringify(sampleReg, null, 2)}</pre>
                    `, 'success');
                } else {
                    addResult('â„¹ï¸ Registrations è¡¨ç‚ºç©º', `
                        <p>Registrations è¡¨å­˜åœ¨ä½†æ²’æœ‰è³‡æ–™ã€‚</p>
                        <p>é€™æ˜¯æ­£å¸¸çš„ï¼Œç•¶æœ‰ç”¨æˆ¶å ±åæ™‚æ‰æœƒæœ‰è³‡æ–™ã€‚</p>
                    `, 'info');
                }

            } catch (error) {
                addResult('âŒ Registrations è¡¨æª¢æŸ¥å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkDataIntegrity() {
            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰æ´»å‹•è³‡æ–™
                const { data: eventsData, error: eventsError } = await window.supabaseClient
                    .from('events')
                    .select('id, name, active')
                    .eq('active', true);

                if (eventsError) {
                    addResult('âš ï¸ è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥å¤±æ•—', `ç„¡æ³•æª¢æŸ¥æ´»å‹•è³‡æ–™: ${eventsError.message}`, 'warning');
                    return;
                }

                if (!eventsData || eventsData.length === 0) {
                    addResult('âš ï¸ æ²’æœ‰å•Ÿç”¨çš„æ´»å‹•', `
                        <p>ç›®å‰æ²’æœ‰å•Ÿç”¨çš„æ´»å‹•å¯ä¾›å ±åã€‚</p>
                        <p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
                        <ul>
                            <li>ä½¿ç”¨ã€Œå‰µå»ºç¯„ä¾‹è³‡æ–™ã€æŒ‰éˆ•å‰µå»ºæ¸¬è©¦æ´»å‹•</li>
                            <li>æˆ–åœ¨ç®¡ç†å¾Œå°æ‰‹å‹•æ·»åŠ æ´»å‹•</li>
                        </ul>
                    `, 'warning');
                } else {
                    addResult('âœ… è³‡æ–™å®Œæ•´æ€§æ­£å¸¸', `
                        <p><strong>å•Ÿç”¨æ´»å‹•æ•¸é‡ï¼š</strong>${eventsData.length} å€‹</p>
                        <p><strong>æ´»å‹•åˆ—è¡¨ï¼š</strong></p>
                        <ul>
                            ${eventsData.map(event => `<li>${event.name} (ID: ${event.id})</li>`).join('')}
                        </ul>
                    `, 'success');
                }

            } catch (error) {
                addResult('âŒ è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function createSampleData() {
            if (!confirm('ç¢ºå®šè¦å‰µå»ºç¯„ä¾‹è³‡æ–™å—ï¼Ÿé€™å°‡åœ¨è³‡æ–™åº«ä¸­æ·»åŠ æ¸¬è©¦æ´»å‹•ã€‚')) {
                return;
            }

            clearResults();
            addResult('ğŸ”„ æ­£åœ¨å‰µå»ºç¯„ä¾‹è³‡æ–™...', 'è«‹ç¨å€™...', 'info');

            try {
                // é¦–å…ˆæª¢æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
                const { data: eventsData, error: eventsError } = await window.supabaseClient
                    .from('events')
                    .select('id')
                    .limit(1);

                if (eventsError && eventsError.message.includes('relation "events" does not exist')) {
                    addResult('âŒ ç„¡æ³•å‰µå»ºç¯„ä¾‹è³‡æ–™', `
                        <p>Events è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆå‰µå»ºè³‡æ–™åº«çµæ§‹ã€‚</p>
                        <p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
                        <ol>
                            <li>åœ¨ Supabase æ§åˆ¶å°åŸ·è¡Œä»¥ä¸‹ SQL è…³æœ¬ï¼š</li>
                        </ol>
                        <pre>
-- å‰µå»º events è¡¨
CREATE TABLE events (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(100),
    date DATE NOT NULL,
    time TIME,
    location VARCHAR(255),
    capacity INTEGER DEFAULT 30,
    fee DECIMAL(10,2) DEFAULT 0,
    description TEXT,
    active BOOLEAN DEFAULT true,
    poster_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å‰µå»º registrations è¡¨
CREATE TABLE registrations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    event_id UUID REFERENCES events(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    grade VARCHAR(50) NOT NULL,
    class VARCHAR(50) NOT NULL,
    seat_number INTEGER NOT NULL,
    registration_date DATE NOT NULL,
    notes TEXT,
    status VARCHAR(50) DEFAULT 'pending',
    submitted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å•Ÿç”¨ RLS
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
ALTER TABLE registrations ENABLE ROW LEVEL SECURITY;

-- å‰µå»ºæ”¿ç­–
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥è®€å–æ´»å‹•" ON events FOR SELECT USING (true);
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥æ–°å¢å ±å" ON registrations FOR INSERT WITH CHECK (true);
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥è®€å–å ±åè³‡æ–™" ON registrations FOR SELECT USING (true);
                        </pre>
                    `, 'error');
                    return;
                }

                // å‰µå»ºç¯„ä¾‹æ´»å‹•
                const sampleEvents = [
                    {
                        name: 'æ˜¥å­£æˆ¶å¤–æ•™å­¸',
                        type: 'æˆ¶å¤–æ´»å‹•',
                        date: '2024-03-15',
                        time: '09:00',
                        location: 'é™½æ˜å±±åœ‹å®¶å…¬åœ’',
                        capacity: 30,
                        fee: 0,
                        description: 'å¸¶é ˜å­¸ç”Ÿè¦ªè¿‘å¤§è‡ªç„¶ï¼Œå­¸ç¿’ç”Ÿæ…‹çŸ¥è­˜',
                        active: true
                    },
                    {
                        name: 'ç§‘å­¸å¯¦é©—èª²ç¨‹',
                        type: 'å®¤å…§æ´»å‹•',
                        date: '2024-03-20',
                        time: '14:00',
                        location: 'å­¸æ ¡å¯¦é©—å®¤',
                        capacity: 25,
                        fee: 100,
                        description: 'æœ‰è¶£çš„ç§‘å­¸å¯¦é©—ï¼ŒåŸ¹é¤Šå­¸ç”Ÿå°ç§‘å­¸çš„èˆˆè¶£',
                        active: true
                    },
                    {
                        name: 'ç¾è¡“å‰µä½œå·¥ä½œåŠ',
                        type: 'è—è¡“æ´»å‹•',
                        date: '2024-03-25',
                        time: '10:00',
                        location: 'ç¾è¡“æ•™å®¤',
                        capacity: 20,
                        fee: 50,
                        description: 'å­¸ç¿’ç¹ªç•«æŠ€å·§ï¼Œç™¼æ®å‰µæ„æƒ³åƒ',
                        active: true
                    }
                ];

                const { data, error } = await window.supabaseClient
                    .from('events')
                    .insert(sampleEvents)
                    .select();

                if (error) throw error;

                addResult('âœ… ç¯„ä¾‹è³‡æ–™å‰µå»ºæˆåŠŸ', `
                    <p>æˆåŠŸå‰µå»º ${data.length} å€‹æ¸¬è©¦æ´»å‹•ï¼š</p>
                    <ul>
                        ${data.map(event => `<li><strong>${event.name}</strong> - ${event.date} ${event.time}</li>`).join('')}
                    </ul>
                    <p>ç¾åœ¨å¯ä»¥è¿”å›ä¸»é é¢æŸ¥çœ‹æ´»å‹•åˆ—è¡¨äº†ï¼</p>
                `, 'success');

            } catch (error) {
                addResult('âŒ å‰µå»ºç¯„ä¾‹è³‡æ–™å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'error');
                console.error('å‰µå»ºç¯„ä¾‹è³‡æ–™å¤±æ•—:', error);
            }
        }

        async function clearAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }

            clearResults();
            addResult('ğŸ—‘ï¸ æ­£åœ¨æ¸…é™¤æ‰€æœ‰è³‡æ–™...', 'è«‹ç¨å€™...', 'warning');

            try {
                // æ¸…é™¤ registrations è¡¨
                const { error: regError } = await window.supabaseClient
                    .from('registrations')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');

                if (regError) {
                    addResult('âš ï¸ æ¸…é™¤å ±åè³‡æ–™å¤±æ•—', `éŒ¯èª¤: ${regError.message}`, 'warning');
                } else {
                    addResult('âœ… å ±åè³‡æ–™å·²æ¸…é™¤', 'æ‰€æœ‰å ±åè¨˜éŒ„å·²åˆªé™¤', 'success');
                }

                // æ¸…é™¤ events è¡¨
                const { error: eventsError } = await window.supabaseClient
                    .from('events')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');

                if (eventsError) {
                    addResult('âš ï¸ æ¸…é™¤æ´»å‹•è³‡æ–™å¤±æ•—', `éŒ¯èª¤: ${eventsError.message}`, 'warning');
                } else {
                    addResult('âœ… æ´»å‹•è³‡æ–™å·²æ¸…é™¤', 'æ‰€æœ‰æ´»å‹•è¨˜éŒ„å·²åˆªé™¤', 'success');
                }

                addResult('âœ… æ¸…é™¤å®Œæˆ', 'æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼Œè³‡æ–™åº«ç¾åœ¨æ˜¯ç©ºçš„', 'success');

            } catch (error) {
                addResult('âŒ æ¸…é™¤è³‡æ–™å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'error');
                console.error('æ¸…é™¤è³‡æ–™å¤±æ•—:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            checkDatabaseStatus();
        });
    </script>
</body>
</html>
