<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‰éˆ•åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4facfe;
            color: white;
        }
        button:hover { background: #00f2fe; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-result.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .test-result.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .test-result.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”˜ æŒ‰éˆ•åŠŸèƒ½æ¸¬è©¦å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨æ–¼æ¸¬è©¦ç³»çµ±ä¸­æ‰€æœ‰æŒ‰éˆ•çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚</p>

        <div class="test-section">
            <h3>1. åŸºæœ¬æŒ‰éˆ•æ¸¬è©¦</h3>
            <button onclick="testBasicButtons()">æ¸¬è©¦åŸºæœ¬æŒ‰éˆ•</button>
            <button onclick="testEventListeners()">æ¸¬è©¦äº‹ä»¶ç›£è½å™¨</button>
            <button onclick="testSecurityFeatures()">æ¸¬è©¦å®‰å…¨åŠŸèƒ½</button>
            <div id="basicTestResult"></div>
        </div>

        <div class="test-section">
            <h3>2. è¡¨å–®æŒ‰éˆ•æ¸¬è©¦</h3>
            <button onclick="testFormButtons()">æ¸¬è©¦è¡¨å–®æŒ‰éˆ•</button>
            <button onclick="testFormValidation()">æ¸¬è©¦è¡¨å–®é©—è­‰</button>
            <div id="formTestResult"></div>
        </div>

        <div class="test-section">
            <h3>3. ç®¡ç†å¾Œå°æŒ‰éˆ•æ¸¬è©¦</h3>
            <button onclick="testAdminButtons()">æ¸¬è©¦ç®¡ç†å¾Œå°æŒ‰éˆ•</button>
            <button onclick="testAdminAuth()">æ¸¬è©¦ç®¡ç†å¾Œå°èªè­‰</button>
            <div id="adminTestResult"></div>
        </div>

        <div class="test-section">
            <h3>4. å®‰å…¨åŠŸèƒ½æ¸¬è©¦</h3>
            <button onclick="testRateLimiting()">æ¸¬è©¦é€Ÿç‡é™åˆ¶</button>
            <button onclick="testSecurityMonitoring()">æ¸¬è©¦å®‰å…¨ç›£æ§</button>
            <div id="securityTestResult"></div>
        </div>

        <div class="test-section">
            <h3>5. å®Œæ•´ç³»çµ±æ¸¬è©¦</h3>
            <button onclick="runFullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            <button onclick="clearAllTests()">æ¸…é™¤æ‰€æœ‰æ¸¬è©¦çµæœ</button>
            <div id="fullTestResult"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="security-monitor.js"></script>
    <script src="input-validator.js"></script>
    <script src="rate-limiter.js"></script>

    <script>
        function addTestResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            element.appendChild(resultDiv);
        }

        function clearTestResult(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function testBasicButtons() {
            clearTestResult('basicTestResult');
            addTestResult('basicTestResult', 'é–‹å§‹æ¸¬è©¦åŸºæœ¬æŒ‰éˆ•åŠŸèƒ½...', 'info');

            try {
                // æ¸¬è©¦æŒ‰éˆ•é»æ“Šäº‹ä»¶
                const testButton = document.createElement('button');
                testButton.textContent = 'æ¸¬è©¦æŒ‰éˆ•';
                testButton.onclick = () => {
                    addTestResult('basicTestResult', 'âœ… æŒ‰éˆ•é»æ“Šäº‹ä»¶æ­£å¸¸', 'success');
                };
                
                // æ¨¡æ“¬é»æ“Š
                testButton.click();
                
                // æ¸¬è©¦äº‹ä»¶ç›£è½å™¨
                let eventListenerWorked = false;
                const testElement = document.createElement('div');
                testElement.addEventListener('click', () => {
                    eventListenerWorked = true;
                });
                testElement.click();
                
                if (eventListenerWorked) {
                    addTestResult('basicTestResult', 'âœ… äº‹ä»¶ç›£è½å™¨æ­£å¸¸', 'success');
                } else {
                    addTestResult('basicTestResult', 'âš ï¸ äº‹ä»¶ç›£è½å™¨å¯èƒ½æœ‰å•é¡Œ', 'warning');
                }

                // æ¸¬è©¦ DOM æ“ä½œ
                const testDiv = document.createElement('div');
                testDiv.id = 'testDiv';
                document.body.appendChild(testDiv);
                const foundDiv = document.getElementById('testDiv');
                if (foundDiv) {
                    addTestResult('basicTestResult', 'âœ… DOM æ“ä½œæ­£å¸¸', 'success');
                    document.body.removeChild(testDiv);
                } else {
                    addTestResult('basicTestResult', 'âŒ DOM æ“ä½œå¤±æ•—', 'error');
                }

            } catch (error) {
                addTestResult('basicTestResult', `âŒ åŸºæœ¬æŒ‰éˆ•æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testEventListeners() {
            clearTestResult('basicTestResult');
            addTestResult('basicTestResult', 'é–‹å§‹æ¸¬è©¦äº‹ä»¶ç›£è½å™¨...', 'info');

            try {
                // æ¸¬è©¦å„ç¨®äº‹ä»¶é¡å‹
                const events = ['click', 'submit', 'change', 'keypress', 'focus', 'blur'];
                let workingEvents = 0;

                events.forEach(eventType => {
                    try {
                        const testElement = document.createElement('div');
                        testElement.addEventListener(eventType, () => {});
                        workingEvents++;
                    } catch (error) {
                        addTestResult('basicTestResult', `âš ï¸ ${eventType} äº‹ä»¶ç›£è½å™¨æœ‰å•é¡Œ: ${error.message}`, 'warning');
                    }
                });

                addTestResult('basicTestResult', `âœ… ${workingEvents}/${events.length} å€‹äº‹ä»¶é¡å‹æ­£å¸¸`, 'success');

                // æ¸¬è©¦äº‹ä»¶å†’æ³¡
                const parent = document.createElement('div');
                const child = document.createElement('button');
                child.textContent = 'æ¸¬è©¦å†’æ³¡';
                parent.appendChild(child);
                
                let bubbleWorked = false;
                parent.addEventListener('click', () => {
                    bubbleWorked = true;
                });
                
                child.click();
                
                if (bubbleWorked) {
                    addTestResult('basicTestResult', 'âœ… äº‹ä»¶å†’æ³¡æ­£å¸¸', 'success');
                } else {
                    addTestResult('basicTestResult', 'âš ï¸ äº‹ä»¶å†’æ³¡å¯èƒ½æœ‰å•é¡Œ', 'warning');
                }

            } catch (error) {
                addTestResult('basicTestResult', `âŒ äº‹ä»¶ç›£è½å™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testSecurityFeatures() {
            clearTestResult('basicTestResult');
            addTestResult('basicTestResult', 'é–‹å§‹æ¸¬è©¦å®‰å…¨åŠŸèƒ½...', 'info');

            try {
                // æ¸¬è©¦å®‰å…¨ç›£æ§
                if (window.securityMonitor) {
                    addTestResult('basicTestResult', 'âœ… å®‰å…¨ç›£æ§å·²è¼‰å…¥', 'success');
                    
                    const stats = window.securityMonitor.getSecurityReport();
                    addTestResult('basicTestResult', `ğŸ“Š å®‰å…¨äº‹ä»¶çµ±è¨ˆ: ${stats.totalEvents} å€‹äº‹ä»¶`, 'info');
                } else {
                    addTestResult('basicTestResult', 'âš ï¸ å®‰å…¨ç›£æ§æœªè¼‰å…¥', 'warning');
                }

                // æ¸¬è©¦é€Ÿç‡é™åˆ¶
                if (window.rateLimiter) {
                    addTestResult('basicTestResult', 'âœ… é€Ÿç‡é™åˆ¶å™¨å·²è¼‰å…¥', 'success');
                    
                    const stats = window.rateLimiter.getStats();
                    addTestResult('basicTestResult', `ğŸ“Š é€Ÿç‡é™åˆ¶çµ±è¨ˆ: ${stats.activeClients} å€‹æ´»èºå®¢æˆ¶ç«¯`, 'info');
                } else {
                    addTestResult('basicTestResult', 'âš ï¸ é€Ÿç‡é™åˆ¶å™¨æœªè¼‰å…¥', 'warning');
                }

                // æ¸¬è©¦è¼¸å…¥é©—è­‰
                if (window.SecureInputValidator) {
                    addTestResult('basicTestResult', 'âœ… è¼¸å…¥é©—è­‰å™¨å·²è¼‰å…¥', 'success');
                    
                    const validator = new window.SecureInputValidator();
                    const testResult = validator.validate('name', 'æ¸¬è©¦å§“å');
                    if (testResult.isValid) {
                        addTestResult('basicTestResult', 'âœ… è¼¸å…¥é©—è­‰åŠŸèƒ½æ­£å¸¸', 'success');
                    } else {
                        addTestResult('basicTestResult', 'âš ï¸ è¼¸å…¥é©—è­‰åŠŸèƒ½æœ‰å•é¡Œ', 'warning');
                    }
                } else {
                    addTestResult('basicTestResult', 'âš ï¸ è¼¸å…¥é©—è­‰å™¨æœªè¼‰å…¥', 'warning');
                }

            } catch (error) {
                addTestResult('basicTestResult', `âŒ å®‰å…¨åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testFormButtons() {
            clearTestResult('formTestResult');
            addTestResult('formTestResult', 'é–‹å§‹æ¸¬è©¦è¡¨å–®æŒ‰éˆ•...', 'info');

            try {
                // å‰µå»ºæ¸¬è©¦è¡¨å–®
                const testForm = document.createElement('form');
                testForm.id = 'testForm';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.name = 'name';
                nameInput.value = 'æ¸¬è©¦å§“å';
                
                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.textContent = 'æäº¤';
                
                testForm.appendChild(nameInput);
                testForm.appendChild(submitButton);
                document.body.appendChild(testForm);

                // æ¸¬è©¦è¡¨å–®æäº¤
                let formSubmitted = false;
                testForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    formSubmitted = true;
                    addTestResult('formTestResult', 'âœ… è¡¨å–®æäº¤äº‹ä»¶æ­£å¸¸', 'success');
                });

                submitButton.click();

                if (formSubmitted) {
                    addTestResult('formTestResult', 'âœ… è¡¨å–®æŒ‰éˆ•åŠŸèƒ½æ­£å¸¸', 'success');
                } else {
                    addTestResult('formTestResult', 'âš ï¸ è¡¨å–®æŒ‰éˆ•å¯èƒ½æœ‰å•é¡Œ', 'warning');
                }

                // æ¸…ç†
                document.body.removeChild(testForm);

            } catch (error) {
                addTestResult('formTestResult', `âŒ è¡¨å–®æŒ‰éˆ•æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testFormValidation() {
            clearTestResult('formTestResult');
            addTestResult('formTestResult', 'é–‹å§‹æ¸¬è©¦è¡¨å–®é©—è­‰...', 'info');

            try {
                if (window.SecureInputValidator) {
                    const validator = new window.SecureInputValidator();
                    
                    // æ¸¬è©¦å„ç¨®è¼¸å…¥
                    const testCases = [
                        { field: 'name', value: 'å¼µä¸‰', expected: true },
                        { field: 'name', value: '', expected: false },
                        { field: 'class', value: 'å¿ ', expected: true },
                        { field: 'class', value: 'ç„¡æ•ˆ', expected: false },
                        { field: 'seatNumber', value: '15', expected: true },
                        { field: 'seatNumber', value: '50', expected: false }
                    ];

                    let passedTests = 0;
                    testCases.forEach(testCase => {
                        const result = validator.validate(testCase.field, testCase.value);
                        if (result.isValid === testCase.expected) {
                            passedTests++;
                        } else {
                            addTestResult('formTestResult', `âš ï¸ é©—è­‰æ¸¬è©¦å¤±æ•—: ${testCase.field} = "${testCase.value}"`, 'warning');
                        }
                    });

                    addTestResult('formTestResult', `âœ… ${passedTests}/${testCases.length} å€‹é©—è­‰æ¸¬è©¦é€šé`, 'success');
                } else {
                    addTestResult('formTestResult', 'âŒ è¼¸å…¥é©—è­‰å™¨æœªè¼‰å…¥', 'error');
                }

            } catch (error) {
                addTestResult('formTestResult', `âŒ è¡¨å–®é©—è­‰æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testAdminButtons() {
            clearTestResult('adminTestResult');
            addTestResult('adminTestResult', 'é–‹å§‹æ¸¬è©¦ç®¡ç†å¾Œå°æŒ‰éˆ•...', 'info');

            try {
                // æ¸¬è©¦èªè­‰ç®¡ç†å™¨
                if (window.SecureAuthManager) {
                    addTestResult('adminTestResult', 'âœ… èªè­‰ç®¡ç†å™¨å·²è¼‰å…¥', 'success');
                    
                    // æ¸¬è©¦èªè­‰åŠŸèƒ½ï¼ˆä¸å¯¦éš›ç™»å…¥ï¼‰
                    const authManager = new window.SecureAuthManager();
                    addTestResult('adminTestResult', 'âœ… èªè­‰ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    addTestResult('adminTestResult', 'âš ï¸ èªè­‰ç®¡ç†å™¨æœªè¼‰å…¥', 'warning');
                }

                // æ¸¬è©¦ Supabase é€£æ¥
                if (window.supabaseClient) {
                    addTestResult('adminTestResult', 'âœ… Supabase å®¢æˆ¶ç«¯å·²è¼‰å…¥', 'success');
                } else {
                    addTestResult('adminTestResult', 'âŒ Supabase å®¢æˆ¶ç«¯æœªè¼‰å…¥', 'error');
                }

            } catch (error) {
                addTestResult('adminTestResult', `âŒ ç®¡ç†å¾Œå°æŒ‰éˆ•æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testAdminAuth() {
            clearTestResult('adminTestResult');
            addTestResult('adminTestResult', 'é–‹å§‹æ¸¬è©¦ç®¡ç†å¾Œå°èªè­‰...', 'info');

            try {
                if (window.SecureAuthManager) {
                    const authManager = new window.SecureAuthManager();
                    
                    // æ¸¬è©¦å¯†ç¢¼é›œæ¹Š
                    authManager.hashPassword('test123').then(hash => {
                        if (hash && hash.length > 0) {
                            addTestResult('adminTestResult', 'âœ… å¯†ç¢¼é›œæ¹ŠåŠŸèƒ½æ­£å¸¸', 'success');
                        } else {
                            addTestResult('adminTestResult', 'âš ï¸ å¯†ç¢¼é›œæ¹ŠåŠŸèƒ½æœ‰å•é¡Œ', 'warning');
                        }
                    }).catch(error => {
                        addTestResult('adminTestResult', `âŒ å¯†ç¢¼é›œæ¹Šå¤±æ•—: ${error.message}`, 'error');
                    });

                    // æ¸¬è©¦è¼¸å…¥é©—è­‰
                    const validInput = authManager.validateInput('admin');
                    if (validInput) {
                        addTestResult('adminTestResult', 'âœ… è¼¸å…¥é©—è­‰åŠŸèƒ½æ­£å¸¸', 'success');
                    } else {
                        addTestResult('adminTestResult', 'âš ï¸ è¼¸å…¥é©—è­‰åŠŸèƒ½æœ‰å•é¡Œ', 'warning');
                    }

                } else {
                    addTestResult('adminTestResult', 'âŒ èªè­‰ç®¡ç†å™¨æœªè¼‰å…¥', 'error');
                }

            } catch (error) {
                addTestResult('adminTestResult', `âŒ ç®¡ç†å¾Œå°èªè­‰æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testRateLimiting() {
            clearTestResult('securityTestResult');
            addTestResult('securityTestResult', 'é–‹å§‹æ¸¬è©¦é€Ÿç‡é™åˆ¶...', 'info');

            try {
                if (window.rateLimiter) {
                    const result = window.rateLimiter.checkRateLimit();
                    if (result.allowed) {
                        addTestResult('securityTestResult', `âœ… é€Ÿç‡é™åˆ¶æ­£å¸¸ (å‰©é¤˜: ${result.remaining})`, 'success');
                    } else {
                        addTestResult('securityTestResult', `âš ï¸ é€Ÿç‡é™åˆ¶è§¸ç™¼: ${result.reason}`, 'warning');
                    }
                } else {
                    addTestResult('securityTestResult', 'âŒ é€Ÿç‡é™åˆ¶å™¨æœªè¼‰å…¥', 'error');
                }

                if (window.formLimiter) {
                    const testFormData = { name: 'æ¸¬è©¦', class: 'å¿ ', seatNumber: '15' };
                    const result = window.formLimiter.checkFormSubmission(testFormData);
                    if (result.allowed) {
                        addTestResult('securityTestResult', `âœ… è¡¨å–®é€Ÿç‡é™åˆ¶æ­£å¸¸ (å‰©é¤˜: ${result.remaining})`, 'success');
                    } else {
                        addTestResult('securityTestResult', `âš ï¸ è¡¨å–®é€Ÿç‡é™åˆ¶è§¸ç™¼: ${result.reason}`, 'warning');
                    }
                } else {
                    addTestResult('securityTestResult', 'âŒ è¡¨å–®é€Ÿç‡é™åˆ¶å™¨æœªè¼‰å…¥', 'error');
                }

            } catch (error) {
                addTestResult('securityTestResult', `âŒ é€Ÿç‡é™åˆ¶æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testSecurityMonitoring() {
            clearTestResult('securityTestResult');
            addTestResult('securityTestResult', 'é–‹å§‹æ¸¬è©¦å®‰å…¨ç›£æ§...', 'info');

            try {
                if (window.securityMonitor) {
                    const report = window.securityMonitor.getSecurityReport();
                    addTestResult('securityTestResult', `âœ… å®‰å…¨ç›£æ§æ­£å¸¸ (${report.totalEvents} å€‹äº‹ä»¶)`, 'success');
                    
                    if (report.suspiciousEvents > 0) {
                        addTestResult('securityTestResult', `âš ï¸ ç™¼ç¾ ${report.suspiciousEvents} å€‹å¯ç–‘äº‹ä»¶`, 'warning');
                    } else {
                        addTestResult('securityTestResult', 'âœ… æ²’æœ‰å¯ç–‘äº‹ä»¶', 'success');
                    }
                } else {
                    addTestResult('securityTestResult', 'âŒ å®‰å…¨ç›£æ§æœªè¼‰å…¥', 'error');
                }

            } catch (error) {
                addTestResult('securityTestResult', `âŒ å®‰å…¨ç›£æ§æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function runFullTest() {
            clearTestResult('fullTestResult');
            addTestResult('fullTestResult', 'é–‹å§‹åŸ·è¡Œå®Œæ•´ç³»çµ±æ¸¬è©¦...', 'info');

            // ä¾æ¬¡åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
            setTimeout(() => testBasicButtons(), 100);
            setTimeout(() => testEventListeners(), 200);
            setTimeout(() => testSecurityFeatures(), 300);
            setTimeout(() => testFormButtons(), 400);
            setTimeout(() => testFormValidation(), 500);
            setTimeout(() => testAdminButtons(), 600);
            setTimeout(() => testAdminAuth(), 700);
            setTimeout(() => testRateLimiting(), 800);
            setTimeout(() => testSecurityMonitoring(), 900);
            
            setTimeout(() => {
                addTestResult('fullTestResult', 'âœ… å®Œæ•´ç³»çµ±æ¸¬è©¦å®Œæˆ', 'success');
                addTestResult('fullTestResult', 'è«‹æŸ¥çœ‹å„é …æ¸¬è©¦çµæœï¼Œå¦‚æœ‰å•é¡Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°', 'info');
            }, 1000);
        }

        function clearAllTests() {
            const resultElements = ['basicTestResult', 'formTestResult', 'adminTestResult', 'securityTestResult', 'fullTestResult'];
            resultElements.forEach(id => clearTestResult(id));
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', () => {
            addTestResult('fullTestResult', 'ğŸš€ æŒ‰éˆ•åŠŸèƒ½æ¸¬è©¦å·¥å…·å·²è¼‰å…¥', 'info');
            addTestResult('fullTestResult', 'é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦å„é …åŠŸèƒ½', 'info');
        });
    </script>
</body>
</html>
